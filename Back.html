<div class="container">
    <!-- IMAGE SECTION -->
    {{#Image}}
    <div class="image-area">
        <img src="{{Image}}" alt="Image" onerror="this.style.display='none'" onclick="openImageModal(this)">
        <div class="image-overlay"></div>
    </div>
    {{/Image}}

    <div class="content">
        <!-- Header Section -->
        <div class="flex flex-col gap-2">
            <div class="header">
                <h1 class="word">{{Word}}</h1>
                {{#Audio}}
                <!-- Dùng ID để lấy Audio an toàn hơn -->
                <div id="audio-src-hidden" style="display: none;">{{Audio}}</div>
                <div class="audio-btn" id="btn-play-audio">
                    <span class="material-symbols-outlined" style="font-size: 24px;">volume_up</span>
                </div>
                {{/Audio}}
            </div>

            <div class="sub-header">
                {{#POS}} <span class="pos-tag">{{POS}}</span> {{/POS}}
                {{#IPA}} <span class="ipa">{{IPA}}</span> {{/IPA}}
            </div>
        </div>

        <div class="divider"></div>

        <!-- CHECKING SECTION -->
        <div class="details">
            {{#Definition}}
            <div>
                <!-- Đã thêm class check-process vào đây để đồng bộ với mặt trước -->
                <p class="definition-text" tts="on">{{Definition}}</p>
            </div>
            {{/Definition}}

            {{#Example}}
            <div class="example-box" tts="on">
                <p class="example-text check-process">{{Example}}</p>
            </div>
            {{/Example}}
        </div>

        <!-- TAGS -->
        {{#Tag}}
        <div class="tags-section" id="tag-container">{{Tag}}</div>
        {{/Tag}}
        {{#Tags}}
        <div class="tags-section" id="tags-container">{{Tags}}</div>
        {{/Tags}}
    </div>
</div>

<!-- MODAL LIGHTBOX -->
<div id="img-modal" class="modal-backdrop" onclick="closeImageModal()">
    <span class="modal-close-btn">&times;</span>
    <img class="modal-content" id="img-modal-src">
</div>

<script>
    // --- 0. IMAGE MODAL LOGIC ---
    function openImageModal(element) {
        var modal = document.getElementById("img-modal");
        var modalImg = document.getElementById("img-modal-src");
        if(modal && modalImg) {
            modal.style.display = "flex"; 
            modalImg.src = element.src;   
        }
    }

    function closeImageModal() {
        var modal = document.getElementById("img-modal");
        if(modal) modal.style.display = "none";
    }

    // --- MAIN SCRIPT ---
    (function () {
        try {
            // --- 1. SAFE AUDIO PLAY ---
            var audioDiv = document.getElementById('audio-src-hidden');
            var btnAudio = document.getElementById('btn-play-audio');
            
            if (audioDiv) {
                var audioUrl = audioDiv.innerText.trim();
                
                // Auto play logic
                if (audioUrl.length > 0) {
                    setTimeout(function () {
                        var sound = new Audio(audioUrl);
                        sound.play().catch(function(e){ console.log("Audio Error:", e); });
                    }, 300);
                }

                // Click to play logic
                if (btnAudio) {
                    btnAudio.onclick = function(e) {
                        e.stopPropagation();
                        new Audio(audioUrl).play();
                    };
                }
            }

            // --- 2. CHECKING LOGIC ---
            var checkElements = document.querySelectorAll('.check-process');
            var inputIndex = 0;

            checkElements.forEach(function (el) {
                var bolds = el.querySelectorAll('b, strong');
                bolds.forEach(function (b) {
                    var rawText = b.innerText.trim();
                    var correctText = rawText;
                    
                    // Xử lý {Answer|Tip}
                    var match = rawText.match(/^\{([^|]+)\|/);
                    if (match) correctText = match[1];

                    // Lấy kết quả từ Front
                    var userText = sessionStorage.getItem('anki_input_' + inputIndex) || "";

                    var htmlResult = '<span class="diff-container">';
                    var cChars = correctText.split('');
                    var uChars = userText.split('');
                    var maxLength = Math.max(cChars.length, uChars.length);
                    var hasError = false;

                    for (var i = 0; i < maxLength; i++) {
                        var c = cChars[i] || "";
                        var u = uChars[i] || "";
                        
                        // So sánh không phân biệt hoa thường
                        if (c.toLowerCase() === u.toLowerCase()) {
                            htmlResult += '<span class="char-correct">' + c + '</span>';
                        } else {
                            hasError = true;
                            if (u === "") htmlResult += '<span class="char-missing">_</span>';
                            else htmlResult += '<span class="char-wrong">' + u + '</span>';
                        }
                    }
                    htmlResult += '</span>';

                    if (hasError) {
                        htmlResult += ' <span class="correction-arrow">➜</span> <span class="correct-full">' + correctText + '</span>';
                    } else {
                        // Nếu đúng hoàn toàn thì hiển thị màu xanh
                        htmlResult = '<span class="char-correct">' + correctText + '</span>';
                    }
                    
                    b.outerHTML = htmlResult;
                    inputIndex++;
                });

                // Xử lý Tooltip
                var content = el.innerHTML;
                content = content.replace(/\{([^|}]+)\|([^}]+)\}/g, function (match, word, tip) {
                    return '<span class="tip-trigger" data-tip="' + tip + '" onclick="this.classList.toggle(\'active\'); event.stopPropagation();">' + word + '</span>';
                });
                el.innerHTML = content;
            });

            // --- 3. TAGS & OTHER TOOLTIPS ---
            var tooltips = document.querySelectorAll('.process-tooltip');
            tooltips.forEach(function (el) {
                el.innerHTML = el.innerHTML.replace(/\{([^|}]+)\|([^}]+)\}/g, function (match, w, t) {
                    return '<span class="tip-trigger" data-tip="' + t + '" onclick="this.classList.toggle(\'active\'); event.stopPropagation();">' + w + '</span>';
                });
            });

            var tagContainer = document.getElementById('tag-container');
            if (!tagContainer) tagContainer = document.getElementById('tags-container'); // Fallback nếu dùng field Tags
            
            if (tagContainer && tagContainer.innerText.trim()) {
                var tagsText = tagContainer.innerText.trim();
                // Xử lý cả dấu phẩy và dấu cách
                // var tags = tagsText.indexOf(',') > -1 ? tagsText.split(',') : tagsText.split(/\s+/);
                var tags = tagsText.indexOf(',') > -1 ? tagsText.split(',') : tagsText.split(',');

                tagContainer.innerHTML = tags.map(function(t) {
                    return t.trim() ? '<span class="tag-pill">' + t.trim() + '</span>' : '';
                }).join('');
            }

            document.addEventListener('click', function (e) {
                if (!e.target.classList.contains('tip-trigger')) {
                    document.querySelectorAll('.tip-trigger.active').forEach(function(t) {
                        t.classList.remove('active');
                    });
                }
            });

        } catch (err) {
            console.log("Anki Template Error: ", err);
        }
    })();
</script>