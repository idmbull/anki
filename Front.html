<div class="container">
    {{#Image}}
    <div class="image-area placeholder">
        <img src="{{Image}}" alt="Image" onerror="this.style.display='none'">
        <div class="image-overlay"></div>
    </div>
    {{/Image}}

    <div class="content">
        <div class="flex flex-col gap-2">
            <div class="header">
                {{#Vietnamese}}<h1 class="word">{{Vietnamese}}</h1>{{/Vietnamese}}
                {{^Vietnamese}}<h1 class="word">___</h1>{{/Vietnamese}}
                {{#Audio}}
                <div class="audio-btn" onclick="new Audio('{{Audio}}').play(); event.stopPropagation();">
                    <span class="material-symbols-outlined" style="font-size: 24px;">volume_up</span>
                </div>
                {{/Audio}}
            </div>
            <div class="sub-header">
                {{#POS}} <span class="pos-tag">{{POS}}</span> {{/POS}}
            </div>
        </div>

        <div class="divider"></div>

        <div class="details">
            {{#Definition}}
            <div><p class="definition-text input-process blind" tts="on">{{Definition}}</p></div>
            {{/Definition}}
            {{#Example}}
            <div class="example-box"><p class="example-text input-process">{{Example}}</p></div>
            {{/Example}}
        </div>

        <div style="text-align: center; color: var(--text-secondary); font-size: 14px; padding-top:20px; opacity: 0.7;">
            Type answer & Press Enter
        </div>
    </div>
</div>

<script>
    // --- HELPERS ---
    function parseContent(rawText) {
        var clean = rawText.replace(/^\{+/, "").replace(/\}+$/, "");
        var parts = clean.split(/\||ï½œ/); 
        var text = parts[0].trim();
        var hint = parts.length > 1 ? parts[1].trim() : "...";
        if (parts.length === 1 && clean.indexOf('|') === -1) hint = "..."; 
        return { text: text, hint: hint };
    }

    function saveInput(index, value) { sessionStorage.setItem('anki_input_' + index, value); }
    
    function resizeInput(el) {
        var len = el.value.length < 3 ? 3 : el.value.length;
        el.style.width = (len + 2) + 'ch';
    }

    function triggerFlip() {
        if (document.activeElement) document.activeElement.blur();
        setTimeout(function() {
            if (typeof pycmd !== "undefined") pycmd("ans");
            else if (typeof study !== "undefined") study.drawAnswer();
            else if (typeof AnkiDroidJS !== "undefined") AnkiDroidJS.ankiShowAnswer();
        }, 10);
    }

    // --- EVENT DELEGATION ---
    document.addEventListener('input', function(e) {
        if(e.target.classList.contains('cloze-input')) {
            saveInput(e.target.dataset.index, e.target.value);
            resizeInput(e.target);
        }
    });
    
    document.addEventListener('keydown', function(e) {
        if(e.target.classList.contains('cloze-input') && (e.key === "Enter" || e.keyCode === 13)) {
            e.preventDefault(); triggerFlip();
        }
    });

    // --- MAIN LOGIC ---
    (function() {
        sessionStorage.clear();
        var containers = document.querySelectorAll('.input-process');
        var inputIndex = 0;

        containers.forEach(function(container) {
            var bolds = container.querySelectorAll('b, strong, span[style*="font-weight: bold"]');
            bolds.forEach(function(b) {
                var data = parseContent(b.textContent);
                
                if (b.closest('.blind')) {
                    b.outerHTML = '<span class="blind-underline">' + '.'.repeat(data.text.length || 3) + '</span>';
                    return;
                }

                var width = Math.max(data.text.length, data.hint.length) + 3;
                var html = '<input type="text" class="cloze-input" data-index="' + inputIndex + '"' +
                           ' placeholder="' + data.hint + '" autocomplete="off" style="width:' + width + 'ch">';
                
                b.outerHTML = html;
                inputIndex++;
            });

            var content = container.innerHTML;
            if(content.indexOf('{') > -1) {
                content = content.replace(/\{([^|}]+)\|([^}]+)\}/g, function(match, word, tip) {
                    return '<span class="tip-trigger" data-tip="' + tip + '" onclick="this.classList.toggle(\'active\'); event.stopPropagation();">' + word + '</span>';
                });
                container.innerHTML = content;
            }
        });

        setTimeout(function() {
            var first = document.querySelector('.cloze-input');
            if(first) first.focus();
        }, 100);
    })();
</script>